name: è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: æ„å»ºåŒ…
      run: |
        python -m build
    
    - name: è¿è¡Œæµ‹è¯•
      run: |
        pip install -r requirements.txt
        python -m pytest tests/ -v
    
    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        # è·å–å½“å‰æ ‡ç­¾
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        echo "current_tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
        
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^)
        echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        echo "## ğŸš€ å˜æ›´å†…å®¹" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # è·å–æäº¤è®°å½•
        git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG} >> CHANGELOG.md
        
        # æŒ‰ç±»å‹åˆ†ç±»æäº¤
        echo "" >> CHANGELOG.md
        echo "### âœ¨ æ–°åŠŸèƒ½" >> CHANGELOG.md
        git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG} | grep "^- feat:" || echo "- æ— æ–°åŠŸèƒ½" >> CHANGELOG.md
        
        echo "" >> CHANGELOG.md
        echo "### ğŸ› Bug ä¿®å¤" >> CHANGELOG.md
        git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG} | grep "^- fix:" || echo "- æ—  Bug ä¿®å¤" >> CHANGELOG.md
        
        echo "" >> CHANGELOG.md
        echo "### ğŸ“š æ–‡æ¡£æ›´æ–°" >> CHANGELOG.md
        git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG} | grep "^- docs:" || echo "- æ— æ–‡æ¡£æ›´æ–°" >> CHANGELOG.md
        
        echo "" >> CHANGELOG.md
        echo "### ğŸ”§ å…¶ä»–å˜æ›´" >> CHANGELOG.md
        git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG} | grep -v "^- feat:" | grep -v "^- fix:" | grep -v "^- docs:" || echo "- æ— å…¶ä»–å˜æ›´" >> CHANGELOG.md
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        echo "" >> CHANGELOG.md
        echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> CHANGELOG.md
        echo "- ğŸ“… å‘å¸ƒæ—¥æœŸ: $(date +'%Y-%m-%d %H:%M:%S')" >> CHANGELOG.md
        echo "- ğŸ·ï¸ ç‰ˆæœ¬: ${CURRENT_TAG}" >> CHANGELOG.md
        echo "- ğŸ“ æäº¤æ•°: $(git rev-list --count ${PREV_TAG}..${CURRENT_TAG})" >> CHANGELOG.md
        echo "- ğŸ‘¥ è´¡çŒ®è€…: $(git shortlog -sn ${PREV_TAG}..${CURRENT_TAG} | wc -l)" >> CHANGELOG.md
        
        # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.changelog.outputs.current_tag }}
        name: Release ${{ steps.changelog.outputs.current_tag }}
        body: ${{ steps.changelog.outputs.changelog_content }}
        draft: false
        prerelease: false
        files: |
          dist/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: å‘å¸ƒåˆ° PyPI (å¯é€‰)
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒåˆ° PyPI..."
        echo "ğŸ” é…ç½® PyPI å‡­è¯..."
        # twine upload dist/*
        echo "âœ… å‘å¸ƒå®Œæˆ!"
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
    
    - name: é€šçŸ¥å‘å¸ƒç»“æœ
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const tag = process.env.GITHUB_REF.replace('refs/tags/', '');
          const success = '${{ job.status }}' === 'success';
          
          const message = success 
            ? `ğŸ‰ **å‘å¸ƒæˆåŠŸ!** ç‰ˆæœ¬ ${tag} å·²ç»å‘å¸ƒåˆ° GitHub Releases`
            : `âŒ **å‘å¸ƒå¤±è´¥!** ç‰ˆæœ¬ ${tag} å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯`;
          
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥åˆ° Slackã€Discord ç­‰
          console.log(message);
          
          // åˆ›å»º issue é€šçŸ¥å‘å¸ƒç»“æœ
          if (success) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ ç‰ˆæœ¬ ${tag} å‘å¸ƒæˆåŠŸ`,
              body: `ç‰ˆæœ¬ ${tag} å·²æˆåŠŸå‘å¸ƒï¼\n\næŸ¥çœ‹å‘å¸ƒè¯¦æƒ…: https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag}`,
              labels: ['release', 'announcement']
            });
          }

  deploy-docs:
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: éƒ¨ç½²æ–‡æ¡£
      run: |
        echo "ğŸ“š éƒ¨ç½²æ–‡æ¡£åˆ° GitHub Pages..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡æ¡£éƒ¨ç½²è„šæœ¬
        echo "âœ… æ–‡æ¡£éƒ¨ç½²å®Œæˆ!"
    
    - name: æ›´æ–° README å¾½ç« 
      run: |
        echo "ğŸ·ï¸ æ›´æ–° README ä¸­çš„ç‰ˆæœ¬å¾½ç« ..."
        TAG=${GITHUB_REF#refs/tags/}
        echo "æœ€æ–°ç‰ˆæœ¬: ${TAG}"
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–° README çš„è„šæœ¬