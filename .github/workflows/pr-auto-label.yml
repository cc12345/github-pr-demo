name: PR è‡ªåŠ¨æ ‡ç­¾

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
    - name: æ ¹æ® PR æ ‡é¢˜è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
      uses: actions/github-script@v7
      with:
        script: |
          const title = context.payload.pull_request.title.toLowerCase();
          const labels = [];
          
          // æ ¹æ®æäº¤ç±»å‹æ·»åŠ æ ‡ç­¾
          if (title.startsWith('feat:')) {
            labels.push('enhancement');
          } else if (title.startsWith('fix:')) {
            labels.push('bug');
          } else if (title.startsWith('docs:')) {
            labels.push('documentation');
          } else if (title.startsWith('test:')) {
            labels.push('tests');
          } else if (title.startsWith('refactor:')) {
            labels.push('refactor');
          } else if (title.startsWith('style:')) {
            labels.push('style');
          } else if (title.startsWith('chore:')) {
            labels.push('chore');
          }
          
          // æ ¹æ®æ–‡ä»¶å˜æ›´æ·»åŠ æ ‡ç­¾
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });
          
          const changedFiles = files.map(f => f.filename);
          
          if (changedFiles.some(f => f.startsWith('src/'))) {
            labels.push('code-change');
          }
          
          if (changedFiles.some(f => f.startsWith('tests/'))) {
            labels.push('test-change');
          }
          
          if (changedFiles.some(f => f.startsWith('docs/') || f.endsWith('.md'))) {
            labels.push('documentation');
          }
          
          if (changedFiles.some(f => f.includes('requirements.txt') || f.includes('setup.py'))) {
            labels.push('dependencies');
          }
          
          if (changedFiles.some(f => f.startsWith('.github/'))) {
            labels.push('ci-cd');
          }
          
          // è®¡ç®—å˜æ›´è§„æ¨¡
          const totalChanges = files.reduce((sum, f) => sum + f.additions + f.deletions, 0);
          
          if (totalChanges > 500) {
            labels.push('large-change');
          } else if (totalChanges > 100) {
            labels.push('medium-change');
          } else {
            labels.push('small-change');
          }
          
          // æ·»åŠ æ ‡ç­¾
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [...new Set(labels)] // å»é‡
            });
          }
    
    - name: æ·»åŠ  PR å¤§å°è¯„ä¼°è¯„è®º
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });
          
          const totalChanges = files.reduce((sum, f) => sum + f.additions + f.deletions, 0);
          const fileCount = files.length;
          
          let sizeEmoji = 'ğŸ“';
          let sizeDescription = '';
          
          if (totalChanges > 500) {
            sizeEmoji = 'ğŸ”¥';
            sizeDescription = 'å¤§å‹å˜æ›´';
          } else if (totalChanges > 100) {
            sizeEmoji = 'ğŸ“Š';
            sizeDescription = 'ä¸­å‹å˜æ›´';
          } else {
            sizeEmoji = 'âœ¨';
            sizeDescription = 'å°å‹å˜æ›´';
          }
          
          const comment = `${sizeEmoji} **PR è§„æ¨¡è¯„ä¼°**

          ğŸ“Š **å˜æ›´ç»Ÿè®¡**
          - ğŸ“ ä¿®æ”¹æ–‡ä»¶æ•°: ${fileCount}
          - â• æ–°å¢è¡Œæ•°: ${files.reduce((sum, f) => sum + f.additions, 0)}
          - â– åˆ é™¤è¡Œæ•°: ${files.reduce((sum, f) => sum + f.deletions, 0)}
          - ğŸ“ˆ æ€»å˜æ›´è¡Œæ•°: ${totalChanges}
          - ğŸ·ï¸ å˜æ›´è§„æ¨¡: ${sizeDescription}

          ğŸ“ **æ–‡ä»¶å˜æ›´åˆ—è¡¨**
          ${files.map(f => `- \`${f.filename}\` (+${f.additions} -${f.deletions})`).join('\n')}

          ${totalChanges > 500 ? 'âš ï¸ **æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªå¤§å‹å˜æ›´ï¼Œå»ºè®®ä»”ç»†å®¡æŸ¥ã€‚' : ''}
          ${totalChanges > 100 && totalChanges <= 500 ? 'ğŸ“‹ **å»ºè®®**: ä¸­å‹å˜æ›´ï¼Œå»ºè®®åˆ†æ¨¡å—å®¡æŸ¥ã€‚' : ''}
          ${totalChanges <= 100 ? 'âœ… **å¾ˆå¥½**: å°å‹å˜æ›´ï¼Œæ˜“äºå®¡æŸ¥ã€‚' : ''}`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: comment
          });
    
    - name: æ£€æŸ¥ PR æ ‡é¢˜æ ¼å¼
      uses: actions/github-script@v7
      with:
        script: |
          const title = context.payload.pull_request.title;
          const validPrefixes = ['feat:', 'fix:', 'docs:', 'style:', 'refactor:', 'test:', 'chore:'];
          
          const hasValidPrefix = validPrefixes.some(prefix => title.startsWith(prefix));
          
          if (!hasValidPrefix) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `âŒ **PR æ ‡é¢˜æ ¼å¼ä¸æ­£ç¡®**

              è¯·ç¡®ä¿ PR æ ‡é¢˜ä»¥ä»¥ä¸‹å‰ç¼€ä¹‹ä¸€å¼€å¤´ï¼š
              - \`feat:\` - æ–°åŠŸèƒ½
              - \`fix:\` - ä¿®å¤ bug
              - \`docs:\` - æ–‡æ¡£æ›´æ–°
              - \`style:\` - ä»£ç æ ¼å¼åŒ–
              - \`refactor:\` - é‡æ„
              - \`test:\` - æµ‹è¯•ç›¸å…³
              - \`chore:\` - æ„å»ºæˆ–è¾…åŠ©å·¥å…·

              **å½“å‰æ ‡é¢˜**: \`${title}\`
              
              **ç¤ºä¾‹**: \`feat: add user authentication\``
            });
          }